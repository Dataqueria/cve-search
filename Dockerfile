FROM python:3.8-alpine

LABEL com.dataqueria="Dataqueria.com"

ENV PYTHONUNBUFFERED 1

# Install system dependencies
RUN apk update \
  && apk add --virtual build-deps gcc python3-dev musl-dev linux-headers hiredis-dev \
  && apk add libcap \
             gmp-dev \
             json-c-dev \
             libpcap \
             libunistring-dev \
             libxml2 \
             libxml2-dev \
             libxslt \
             libxslt-dev \
             \
  && apk add --virtual .deps \
                        build-base \
                        byacc \
                        cmake \
                        flex \
                        gengetopt \
                        git \
                        libpcap-dev \
                        linux-headers \
                        \
  && ln -s /usr/bin/yacc /usr/bin/byacc

WORKDIR /app

COPY ./requirements.txt ./
RUN pip install -r requirements.txt

# Create group and user
RUN addgroup -S app && \
    adduser -S -G app app

COPY . .

RUN chown -R app /app
RUN sed -i 's/\r//' /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

RUN sed -i 's/\r//' /app/start-webserver.sh
RUN chmod +x /app/start-webserver.sh



ENTRYPOINT ["sh", "/app/entrypoint.sh"]
CMD ["/app/start-webserver.sh"]